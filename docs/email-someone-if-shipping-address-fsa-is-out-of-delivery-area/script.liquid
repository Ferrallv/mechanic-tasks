{% assign available_fsa = options.allowed_fsa__required | split: "," %}
{% assign order_fsa = order.shipping_address.zip | slice: 0, 3 %}

{% if available_fsa contains order_fsa %}
	{% assign order_disqualified = false %}
  {% log %}
    {{ "The Fsa (" | append: order_fsa | append: ") for order: " | append: order.name | append: " should be in our delivery area." | json }}
  {% endlog %}
{% else %}
	{% assign order_disqualified = true %}
{% endif %}

{% if event.preview or order_disqualified %}
  {
    "action": {
      "type": "email",
      "options": {
        "to": {{ options.email_recipients__required | json }},
        "subject": {{ options.email_subject__required | strip | json }},
        "body": {{ options.email_body__required_multiline | newline_to_br | strip | json }},
        "reply_to": {{ shop.customer_email | json }},
        "from_display_name": {{ shop.name | json }}
      }
    }
  }

{% endif %}

{% action "echo" %}
  {
    "allowed_fsa": {{ available_fsa | json }}
  }
{% endaction %}
